# æµå…‰å¡ç‰‡ - æµåª’ä½“å¡ç‰‡ç”ŸæˆæœåŠ¡

ä¸€ä¸ªåŸºäº Node.js + Puppeteer çš„é«˜æ€§èƒ½æµåª’ä½“å¡ç‰‡ç”ŸæˆæœåŠ¡ï¼Œæ”¯æŒå¤šå¹³å°ï¼ˆTwitchã€YouTubeã€Bilibiliç­‰ï¼‰çš„ä¸ªæ€§åŒ–å¡ç‰‡ç”Ÿæˆã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ¨ **å¤šæ ·åŒ–æ¨¡æ¿**: æ”¯æŒå¤šç§å¡ç‰‡æ¨¡æ¿å’Œæ ·å¼è‡ªå®šä¹‰
- ğŸŒ **å¤šå¹³å°æ”¯æŒ**: Twitchã€YouTubeã€Bilibiliã€æŠ–éŸ³ç­‰ä¸»æµå¹³å°
- ğŸ“± **å“åº”å¼è®¾è®¡**: æ”¯æŒå¤šç§å°ºå¯¸å’Œæ¯”ä¾‹çš„å¡ç‰‡ç”Ÿæˆ
- ğŸ–¼ï¸ **å¯Œåª’ä½“å†…å®¹**: æ”¯æŒå›¾ç‰‡ã€æ–‡æœ¬ã€Markdownæ··åˆå†…å®¹
- âš¡ **é«˜æ€§èƒ½å¤„ç†**: æ™ºèƒ½å¹¶å‘æ§åˆ¶å’Œç¼“å­˜æœºåˆ¶
- ğŸ³ **å®¹å™¨åŒ–éƒ¨ç½²**: å®Œæ•´çš„Dockerè§£å†³æ–¹æ¡ˆ
- ğŸ”§ **åŒæ¨¡å¼é…ç½®**: æ ‡å‡†é…ç½®å’Œä½é…ç½®æ¨¡å¼
- ğŸ“Š **å¥åº·ç›‘æ§**: å®Œå–„çš„å¥åº·æ£€æŸ¥å’Œæ—¥å¿—ç³»ç»Ÿ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. **å…‹éš†é¡¹ç›®**ï¼š
```bash
git clone https://github.com/xj-bear/streamer-card.git
cd streamer-card
```

2. **é€‰æ‹©ç¯å¢ƒé…ç½®æ–‡ä»¶**ï¼š
   æ ¹æ®æ‚¨çš„æœåŠ¡å™¨é…ç½®ï¼Œä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œå¹¶å°†å…¶é‡å‘½åä¸º `.env`ï¼š
   - `.env.prod`: æ ‡å‡†ç”Ÿäº§ç¯å¢ƒ (æ¨è 2GB+ å†…å­˜)
   - `.env.low-spec`: ä½é…ç½®ç¯å¢ƒ (é€‚ç”¨äº 1GB å†…å­˜)
   - `.env.high-performance`: é«˜æ€§èƒ½ç¯å¢ƒ (é€‚ç”¨äº 4GB+ å†…å­˜)
   - `.env.ultra-performance`: æé™æ€§èƒ½ç¯å¢ƒ (é€‚ç”¨äº 8GB+ å†…å­˜)

   ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨ä½é…ç½®æ¨¡å¼ï¼Œè¯·è¿è¡Œï¼š
   ```bash
   cp .env.low-spec .env
   ```

3. **å¯åŠ¨æœåŠ¡**ï¼š
```bash
docker-compose up -d --build
```

4. **è®¿é—®æœåŠ¡**ï¼š
   - ğŸŒ æœåŠ¡åœ°å€ï¼šhttp://localhost:9200
   - ğŸ”— APIç«¯ç‚¹ï¼šhttp://localhost:9200/api/saveImg
   - ğŸ“Š å¥åº·æ£€æŸ¥ï¼šhttp://localhost:9200/api

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| é…ç½®æ¨¡å¼ | å†…å­˜è¦æ±‚ | æ™®é€šå¡ç‰‡ç”Ÿæˆ | è¶…é•¿å†…å®¹ç”Ÿæˆ | å¹¶å‘å¤„ç† |
|---------|---------|-------------|-------------|---------|
| **æ ‡å‡†é…ç½®** | 2GB+ | ~15-20ç§’ | ~277ç§’ | 2-5ä¸ª |
| **ä½é…ç½®æ¨¡å¼** | 1GB+ | **~4.6ç§’** | **~6.6ç§’** | 1ä¸ª |

> ğŸ’¡ ä½é…ç½®æ¨¡å¼åœ¨è¶…é•¿å†…å®¹å¤„ç†ä¸Šæœ‰**97.6%çš„æ€§èƒ½æå‡**ï¼

## ğŸ–¼ï¸ æ•ˆæœå±•ç¤º

### æ ‡å‡†å¡ç‰‡ç”Ÿæˆ
![æ ‡å‡†å¡ç‰‡](demo-standard-card.png)

### è¶…é•¿å†…å®¹å›¾æ–‡æ··åˆï¼ˆä½é…ç½®æ¨¡å¼ï¼‰
![è¶…é•¿å†…å®¹å¡ç‰‡](demo-long-content-low-spec.png)

## ğŸ“¡ API ä½¿ç”¨

### ç”Ÿæˆå¡ç‰‡

**POST** `/api/saveImg`

**åŸºç¡€è¯·æ±‚ç¤ºä¾‹**ï¼š
```json
{
  "username": "test_streamer",
  "platform": "twitch",
  "useLoadingFont": false
}
```

**å¤æ‚å†…å®¹ç¤ºä¾‹**ï¼š
```json
{
  "form": {
    "icon": "https://example.com/avatar.png",
    "date": "2024å¹´7æœˆ14æ—¥",
    "title": "<p>ğŸ”¥ ç›´æ’­é¢„å‘Š</p>",
    "content": "<p>ä»Šæ™š8ç‚¹ï¼Œç²¾å½©å†…å®¹ä¸å®¹é”™è¿‡ï¼</p>",
    "author": "<p>ä¸»æ’­åç§°</p>",
    "qrCodeTitle": "<p>æ‰«ç å…³æ³¨</p>",
    "qrCodeText": "<p>è·å–æ›´å¤šèµ„è®¯</p>",
    "qrCode": "https://example.com"
  },
  "style": {
    "align": "left",
    "backgroundName": "light-green-color-5",
    "font": "Alibaba-PuHuiTi-Regular",
    "width": 440,
    "ratio": "Auto",
    "fontScale": 1,
    "padding": "30px",
    "borderRadius": "15px",
    "color": "#000000",
    "opacity": 1
  },
  "switchConfig": {
    "showIcon": true,
    "showDate": true,
    "showTitle": true,
    "showContent": true,
    "showAuthor": true,
    "showQRCode": true
  },
  "temp": "tempA",
  "language": "zh"
}
```

### å¥åº·æ£€æŸ¥

**GET** `/api`

è¿”å›ï¼š`hello world`

## âš™ï¸ ç¯å¢ƒé…ç½®

æ‚¨å¯ä»¥é€šè¿‡ç¼–è¾‘æ ¹ç›®å½•ä¸‹çš„ `.env` æ–‡ä»¶æ¥ç²¾ç»†è°ƒæ•´æœåŠ¡çš„æ€§èƒ½å’Œèµ„æºä½¿ç”¨ã€‚è¯¥æ–‡ä»¶ç”± `docker-compose.yml` åŠ è½½ã€‚

æˆ‘ä»¬æä¾›äº†å‡ ç§é¢„è®¾çš„é…ç½®æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦å¤åˆ¶å’Œä¿®æ”¹ï¼š

- `.env.prod`: æ ‡å‡†ç”Ÿäº§ç¯å¢ƒ (æ¨è 2GB+ å†…å­˜)
- `.env.low-spec`: ä½é…ç½®ç¯å¢ƒ (é€‚ç”¨äº 1GB å†…å­˜)
- `.env.high-performance`: é«˜æ€§èƒ½ç¯å¢ƒ (é€‚ç”¨äº 4GB+ å†…å­˜)
- `.env.ultra-performance`: æé™æ€§èƒ½ç¯å¢ƒ (é€‚ç”¨äº 8GB+ å†…å­˜)

**è¦ä½¿ç”¨ç‰¹å®šé…ç½®ï¼Œè¯·å…ˆå°†å…¶å¤åˆ¶ä¸º `.env` æ–‡ä»¶**ï¼Œä¾‹å¦‚ï¼š

```bash
cp .env.prod .env
```

### ç¯å¢ƒå˜é‡è¯¦è§£

| å˜é‡å | æè¿° | é»˜è®¤å€¼ | ä½é…å»ºè®® | é«˜é…å»ºè®® |
| :--- | :--- | :--- | :--- | :--- |
| `NODE_ENV` | è¿è¡Œç¯å¢ƒã€‚**å§‹ç»ˆåº”è®¾ä¸º `production`** ä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚ | `production` | `production` | `production` |
| `IMAGE_NAME` | ç”Ÿæˆçš„ Docker é•œåƒåç§°ã€‚ | `streamer-card-app` | `streamer-card-low-spec` | `streamer-card-high` |
| `CONTAINER_NAME` | è¿è¡Œçš„ Docker å®¹å™¨åç§°ã€‚ | `streamer-card-container` | `streamer-card-low-spec-container` | `streamer-card-high-container` |
| `LOW_SPEC_MODE` | æ˜¯å¦å¯ç”¨ä½é…ç½®æ¨¡å¼ã€‚æ˜¾è‘—é™ä½èµ„æºæ¶ˆè€—ã€‚ | `false` | `true` | `false` |
| `IMAGE_SCALE` | å›¾ç‰‡ç¼©æ”¾æ¯”ä¾‹ã€‚å€¼è¶Šé«˜ï¼Œå›¾ç‰‡è¶Šæ¸…æ™°ï¼Œä½†æ¶ˆè€—èµ„æºè¶Šå¤šã€‚ | `2` | `1` | `2.5` æˆ–æ›´é«˜ |
| `MAX_CONCURRENCY` | æœ€å¤§å¹¶å‘å¤„ç†æ•°ã€‚å€¼è¶Šé«˜ï¼Œååé‡è¶Šå¤§ï¼Œä½†éœ€è¦æ›´å¤š CPU å’Œå†…å­˜ã€‚ | `5` | `1` | `10` æˆ–æ›´é«˜ |
| `MAX_RETRIES` | è¯·æ±‚å¤±è´¥åçš„æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚ | `2` | `1` | `3` |
| `PROTOCOL_TIMEOUT` | Puppeteer å†…éƒ¨åè®®è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚ | `60000` | `120000` | `60000` |
| `NAVIGATION_TIMEOUT` | é¡µé¢å¯¼èˆªè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚ | `120000` | `90000` | `120000` |
| `SCREENSHOT_TIMEOUT` | æˆªå›¾ç”Ÿæˆè¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚ | `60000` | `60000` | `60000` |


## ğŸ”§ ç®¡ç†å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
docker-compose ps
```

### æŸ¥çœ‹å®æ—¶æ—¥å¿—
```bash
docker-compose logs -f
```

### é‡å¯æœåŠ¡
```bash
docker-compose restart
```

### åœæ­¢æœåŠ¡
```bash
docker-compose down
```

## ğŸ› ï¸ æœ¬åœ°å¼€å‘

### ç¯å¢ƒè¦æ±‚
- Node.js 18+
- npm æˆ– yarn
- Chrome/Chromium æµè§ˆå™¨

### å¼€å‘æ­¥éª¤

1. **å®‰è£…ä¾èµ–**ï¼š
```bash
npm install
```

2. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**ï¼š
```bash
npm run dev
```

3. **æ„å»ºé¡¹ç›®**ï¼š
```bash
npm run build
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. Chromeå¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥å®¹å™¨å†…å­˜
docker stats

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs streamer-card
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ä½é…ç½®æ¨¡å¼
- å¢åŠ å®¹å™¨å†…å­˜é™åˆ¶
- æ£€æŸ¥`/dev/shm`æŒ‚è½½

#### 2. å›¾ç‰‡ç”Ÿæˆè¶…æ—¶
**ç—‡çŠ¶**ï¼šè¯·æ±‚è¶…æ—¶æˆ–è¿”å›é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- å¢åŠ è¶…æ—¶æ—¶é—´é…ç½®
- ä½¿ç”¨ä½é…ç½®æ¨¡å¼

#### 3. å†…å­˜ä¸è¶³
**ç—‡çŠ¶**ï¼šå®¹å™¨é¢‘ç¹é‡å¯æˆ–OOM

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åˆ‡æ¢åˆ°ä½é…ç½®æ¨¡å¼
- å‡å°‘å¹¶å‘æ•°
- å¢åŠ æœåŠ¡å™¨å†…å­˜

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### ä½é…ç½®ç¯å¢ƒ
- ä½¿ç”¨`docker-compose.low-spec.yml`
- è®¾ç½®`LOW_SPEC_MODE=true`
- å•å¹¶å‘å¤„ç†é¿å…èµ„æºç«äº‰

#### é«˜æ€§èƒ½ç¯å¢ƒ
- ä½¿ç”¨æ ‡å‡†é…ç½®
- å¢åŠ å¹¶å‘æ•°
- å¯ç”¨2xå›¾ç‰‡ç¼©æ”¾

## ğŸ“ é¡¹ç›®ç»“æ„

```
streamer-card/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ index.ts                    # ä¸»æœåŠ¡æ–‡ä»¶
â”œâ”€â”€ assets/                         # é™æ€èµ„æº
â”œâ”€â”€ docker-compose.yml              # æ ‡å‡†é…ç½®
â”œâ”€â”€ docker-compose.low-spec.yml     # ä½é…ç½®æ¨¡å¼
â”œâ”€â”€ Dockerfile                      # Dockeræ„å»ºæ–‡ä»¶
â”œâ”€â”€ deploy.sh                       # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ test_long_content.json          # æµ‹è¯•æ•°æ®ç¤ºä¾‹
â”œâ”€â”€ demo-standard-card.png          # æ ‡å‡†å¡ç‰‡ç¤ºä¾‹
â”œâ”€â”€ demo-long-content-low-spec.png  # è¶…é•¿å†…å®¹ç¤ºä¾‹
â””â”€â”€ README.md                       # é¡¹ç›®æ–‡æ¡£
```

## ğŸ”¬ æŠ€æœ¯æ ˆ

- **åç«¯æ¡†æ¶**: Node.js + Express + TypeScript
- **æµè§ˆå™¨è‡ªåŠ¨åŒ–**: Puppeteer + Chromium
- **å®¹å™¨åŒ–**: Docker + Docker Compose
- **ç¼“å­˜**: LRU Cache
- **å¹¶å‘æ§åˆ¶**: Puppeteer Cluster

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestï¼

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…ã€‚

## ğŸ™ è‡´è°¢

- [Puppeteer](https://pptr.dev/) - å¼ºå¤§çš„æµè§ˆå™¨è‡ªåŠ¨åŒ–å·¥å…·
- [Express](https://expressjs.com/) - å¿«é€Ÿã€æç®€çš„Webæ¡†æ¶
- [Docker](https://www.docker.com/) - å®¹å™¨åŒ–å¹³å°

---

â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™å®ƒä¸€ä¸ªæ˜Ÿæ ‡ï¼
